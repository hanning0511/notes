Tags: #ssh #network #tunnel
Refs: [tunneling](https://www.ssh.com/academy/ssh/tunneling), [tunneling example](https://www.ssh.com/academy/ssh/tunneling-example), [common configs](https://www.ssh.com/academy/ssh/config)

# 隧道

## 什么是 SSH 隧道?

SSH 隧道又叫做 SSH 端口转发。 它是一种通过加密的 SSH 连接来传输任意网络数据的方法。它可以用来给传统的应用程序添加加密。它还可以用来实现 VPN（虚拟专用网络）和跨越防火墙访问内网服务。

SSH 是一个在不信任的网络上进行安全远程登录和文件传输的标准。它还提供了一种方法，使用端口转发来保护任何特定应用程序的数据流量，基本上是在 SSH 上对任何 TCP/IP 端口进行隧道化。这意味着应用程序的数据流量被引导到一个加密的 SSH 连接内流动，因此它在传输过程中不能被窃听或拦截。SSH 隧道可以为那些不支持加密的传统应用程序增加网络安全。

![[ssh-tunnel.png]]

上图展示了 SSH 隧道的一个简化模型。在一个 SSH 客户端和一个 SSH 服务器之间，通过不受信任的网络建立安全连接。这个 SSH 连接是加密的，保护保密性和完整性，并对通信双方进行认证。

SSH 连接被应用程序用来连接到应用程序服务器。启用隧道后，应用程序联系到 SSH 客户端监听的本地主机上的一个端口。然后，SSH 客户端将应用程序通过其加密的隧道转发到服务器上。然后，服务器连接到实际的应用服务器 -- 通常与 SSH 服务器在同一台机器上或在同一数据中心。因此，应用程序的通信是安全的，不需要修改应用程序或最终用户的工作流程。

## 谁在使用隧道？

缺点是，任何能够登录服务器的用户都可以启用端口转发。这被内部 IT 人员广泛利用，以登录他们的家庭机器或云上的服务器，将一个端口从服务器转发回企业内网到他们的工作机器或合适的服务器。  
  
黑客和恶意软件同样可以利用它来为内部网络留下后门。它还可以用来隐藏攻击者的踪迹，通过允许不受控制的隧道的多个设备来反弹攻击。

## 如何配置隧道？

### 本地转发

本地转发是用来从客户端机器转发一个端口到服务器机器。基本上，SSH 客户端在配置的端口上监听连接，当它收到一个连接时，它将连接调谐到 SSH 服务器。服务器连接到一个配置好的目标端口，可能是在一个与 SSH 服务器不同的机器上。

本地端口转发的典型用途包括：

- 通过跳跃服务器进行隧道会话和文件传输
- 从外部连接到内部网络上的一个服务
- 通过互联网连接到一个远程文件共享服务

相当多的组织通过一个单一的跳转服务器对所有进入的 SSH 进行访问。该服务器可能是一个标准的 Linux/Unix 沙盒，通常有一些额外的加固、入侵检测和/或记录，或者它可能是一个商业跳跃服务器解决方案。

一旦连接被验证，许多跳转服务器允许传入端口转发。这种端口转发很方便，因为它允许精通技术的用户以相当透明的方式使用内部资源。例如，他们可以将本地机器上的一个端口转发到公司内部网络服务器，转发到内部邮件服务器的IMAP端口，转发到本地文件服务器的445和139端口，转发到打印机，转发到版本控制库，或者转发到内部网络上几乎任何其他系统。通常，该端口是通过隧道连接到内部机器上的 SSH 端口。

在 OpenSSH 中，本地端口转发是用 `-L` 选项配置的。

```shell
ssh -L 80:intra.example.com:80 gw.example.com
```

上面的例子打开了与 **gw.example.com** 跳转服务器的连接，并将本地机器上 **80** 端口的任何连接转发给 **intra.example.com** 的 **80** 端口。

默认情况下，任何人（甚至在不同的机器上）都可以连接到 SSH 客户端机器上的指定端口。然而，这可以通过提供一个绑定地址来限制在同一主机上的程序。

```shell
ssh -L 127.0.0.1:80:intra.example.com:80 gw.example.com
```

### 远程转发

在 OpenSSH 中，远程 SSH 端口转发是使用 `-R` 选项指定的。比如说：

```shell
ssh -R 8080:localhost:80 public.example.com
```

这允许远程服务器上的任何人连接到远程服务器的 TCP **8080** 端口。然后，该连接将被隧道化，回到客户主机，客户再与 **localhost** 的 **80** 端口进行 **TCP** 连接。可以用任何其他主机名或 IP 地址代替 localhost 来指定连接的主机。

这个特殊的例子对于让外面的人访问内部的网络服务器很有用。或者将一个内部网络应用暴露在公共互联网上。这可能是由在家工作的雇员或攻击者所为。

默认情况下，OpenSSH 只允许从服务器主机连接到远程转发的端口。然而，服务器配置文件`sshd_config` 中的 `GatewayPorts` 选项可以用来控制这一点。以下是可能的选择

```
GatewayPorts no # 这可以防止从服务器计算机外部连接到转发的端口。
```

```
GatewayPorts yes # 这允许任何人连接到转发的端口。如果服务器是在公共互联网上，互联网上的任何人都可以连接到该端口。
```

```
GatewayPorts clientspecified # 这意味着客户端可以指定一个IP地址，允许从该地址连接到该端口。对应的语法看下面的例子
```

```shell
ssh -R 52.194.1.73:8080:localhost:80 host147.aws.example.com
```

在这个例子中，只允许从 IP 地址 **52.194.1.73** 到端口 **8080** 的连接。

OpenSSH 也允许将转发的远程端口指定为 0，在这种情况下，服务器将动态地分配一个端口并报告给客户端。当与 `-O forward` 选项一起使用时，客户端将把分配的端口号打印到标准输出。

### 打开进入企业的后门

远程 SSH 端口转发通常被员工用来打开进入企业的后门。例如，员工可以从亚马逊 AWS 设置一个自由层服务器，并从办公室登录到该服务器，指定从服务器上的一个端口远程转发到企业内部网络上的一些服务器或应用程序。可以指定多个远程转发，以打开对一个以上的应用程序的访问。

该员工还将在服务器上设置 `GatewayPorts yes`（大多数员工在家里没有固定的 IP 地址，所以他们无法限制 IP 地址）。

例如，下面的命令在 **5432** 端口打开了对内部 Postgres 数据库的访问，在 **2222** 端口打开了内部 SSH 端口:

```shell
ssh -R 2222:d76767.nyc.example.com:22 -R 5432:postgres3.nyc.example.com:5432 aws4.mydomain.net
```

### 服务器端配置

OpenSSH 服务器配置文件中的 `AllowTcpForwarding` 选项必须在服务器上启用以允许端口转发。默认情况下，转发是允许的。这个选项的可能值是 **yes** 或 **all**，允许所有的 TCP 转发；**no**，阻止所有的 TCP 转发；**local**，允许本地转发；**remote**，允许远程转发。

另一个有趣的选项是 `AllowStreamLocalForwarding`，它可以用来转发 Unix 域套接字。它允许与 `AllowTcpForwarding` 相同的值。默认值是 **yes**。

例如：

```
AllowTcpForwarding remote
AllowStreamLocalForwarding no
```

如上所述的 `GatewayPorts` 配置选项也影响到远程端口转发。可能的值是 **no**（只允许来自服务器主机的本地连接；默认值），**yes**（互联网上的任何人都可以连接到远程转发的端口），以及**clientpecified**（客户可以指定一个可以连接的 IP 地址，如果不指定，任何人都可以）。